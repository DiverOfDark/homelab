apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: openwebui
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: openwebui
    server: https://kubernetes.default.svc
  project: default
  source:
    chart: open-webui
    repoURL: https://helm.openwebui.com/
    targetRevision: 5.10.1
    helm:
      valuesObject:
        ollama:
          enabled: false
        websocket:
          enabled: true
        pipelines:
          enabled: false
        ingress:
          enabled: true
          class: traefik
          annotations:
            cert-manager.io/cluster-issuer: acme-issuer
            gethomepage.dev/enabled: "true"
            gethomepage.dev/href: "https://openwebui.kirillorlov.pro"
            gethomepage.dev/group: Apps
            gethomepage.dev/name: openwebui
            gethomepage.dev/icon: openwebui.png
            gethomepage.dev/pod-selector: "app.kubernetes.io/name=openwebui"
          host: openwebui.kirillorlov.pro
          additionalHosts: []
          tls: true
          existingSecret: ""
        persistence:
          storageClass: ceph-filesystem
        extraResources:
          - apiVersion: external-secrets.io/v1beta1
            kind: ExternalSecret
            metadata:
              name: "openai-secret"
              namespace: openwebui
            spec:
              secretStoreRef:
                name: default-secret-store
                kind: ClusterSecretStore  # or ClusterSecretStore

              refreshInterval: "10s"

              target:
                name: openai-secret
                creationPolicy: 'Owner'
                deletionPolicy: "Retain"
                template:
                  type: Opaque
                  data:
                    openai: '{{ .openai }}'
              data:
                - secretKey: openai
                  remoteRef:
                    key: golden-secret
                    conversionStrategy: Default
                    decodingStrategy: None
                    metadataPolicy: None
                    property: openai-api-key

        extraEnvVars:
          - name: OPENAI_API_KEY
            valueFrom:
              secretKeyRef:
                name: openai-secret
                key: openai

  syncPolicy:
    automated:
      prune: true
    syncOptions:
    - CreateNamespace=true
    - ServerSideApply=true
    - RespectIgnoreDifferences=true
